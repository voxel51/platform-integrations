# Voxel51 Platform AWS Igress Client

This project demonstrates how to build an
[AWS Serverless Application Model](https://aws.amazon.com/serverless/sam)
application that uses [AWS Lambda](https://aws.amazon.com/lambda) to
automatically upload all newly-created objects in an S3 Bucket to the Voxel51
Platform using pre-signed URLs and then run a configurable set of analytic(s)
on the data.


## Organization

```
.
├── README.md                   <-- This README
├── src                         <-- Source code for the Lambda function
│   ├── __init__.py
│   ├── app.py                  <-- Lambda function code
│   └── requirements.txt        <-- Lambda function dependencies
└── template.yaml               <-- SAM template
```


## Requirements

- The [Python Client Library](https://github.com/voxel51/api-py) for the
Voxel51 Platform
- A valid [Platform API Token](https://voxel51.com/docs/api/#authentication)
- [AWS CLI](https://aws.amazon.com/cli)
- [AWS SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html)
- [Docker Community Edition](https://hub.docker.com/search/?type=edition&offering=community)
- [jq](https://stedolan.github.io/jq)


## Deploying your application

This section provides CLI commands to package, deploy and describe outputs
defined within the AWS CloudFormation stack.

Before we can deploy anything, we need an S3 bucket where we can upload our
Lambda function packaged as a ZIP file. If you don't have an S3 bucket to store
code artifacts, then this is a good time to create one:

```bash
BUCKET=BUCKET_NAME
aws s3 mb s3://${BUCKET}
```

Next, run the following command to compile dependencies for your Lambda
function. The `sam build` command automatically creates deployment artifacts
that you can deploy to Lambda using the `sam package` and `sam deploy`
commands.

```bash
# Run the build process inside an AWS Lambda-like Docker container
sam build --use-container
```

Next, run the following command to package your Lambda function. The
`sam package` command creates a deployment package (ZIP file) containing your
code and dependencies, and uploads them to the S3 bucket you specify.

```bash
sam package \
    --template-file .aws-sam/build/template.yaml \
    --output-template-file packaged.yaml \
    --s3-bucket ${BUCKET}
```

The `sam deploy` command will create a Cloudformation Stack and deploy your SAM
resources:

```bash
VOXEL51_API_TOKEN=/path/to/your/api-token.json
ANALYTIC_NAMES='voxel51/person-sense,voxel51/road-sense,voxel51/vehicle-sense' # optional

sam deploy \
    --template-file packaged.yaml \
    --stack-name voxel51-platform-ingress \
    --capabilities CAPABILITY_IAM \
    --parameter-overrides \
      AnalyticNames="${ANALYTIC_NAMES}" \
      Voxel51ApiToken=$(cat ${VOXEL51_API_TOKEN} | jq '.access_token|tostring')
```

To see the name of the S3 bucket created after deployment, you can use the
`aws cloudformation describe-stacks` command:

```bash
aws cloudformation describe-stacks \
    --stack-name voxel51-platform-ingress --query 'Stacks[].Outputs'
```

To fetch logs generated by your Lambda function, you can use the
[`sam logs`](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-cli-command-reference-sam-logs.html)
command:

```bash
sam logs -n PostDataAsUrl --stack-name voxel51-platform-ingress
```

Finally, to remove the SAM app, you can use the
[`aws cloudformation delete-stack`](https://docs.aws.amazon.com/cli/latest/reference/cloudformation/delete-stack.html)
command:

```bash
aws cloudformation delete-stack --stack-name voxel51-platform-ingress
```


## Copyright

Copyright 2017-2020, Voxel51, Inc.<br>
[voxel51.com](https://voxel51.com)
